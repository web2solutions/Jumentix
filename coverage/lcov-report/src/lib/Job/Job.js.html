<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/lib/Job/Job.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../prettify.css" />
    <link rel="stylesheet" href="../../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../../index.html">all files</a> / <a href="index.html">src/lib/Job/</a> Job.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">76.81% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>53/69</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">64.52% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>40/62</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">87.5% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>7/8</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">70.37% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>38/54</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">'use strict'
&nbsp;
import CRUD from '../DataAccess/CRUD'
import RabbitEnvelop from '../RabbitEnvelop'
import { validateJob } from '../util'
&nbsp;
/**
 * Handles every Job execution
 * @class
 */
class <span class="branch-1 cbranch-no" title="branch not covered" >J</span>ob extends CRUD {
  /**
   * Creates Job interface
   * @constructor
   * @param {object} application - the application object which this service is plugged to
   */
  constructor (application) {
    super(<span class="branch-1 cbranch-no" title="branch not covered" >a</span>pplication)
    this.isJobDone = false
  }
&nbsp;
  /**
   * send notification to orchestrator worker
   * @param {object} job object
   * @param {object} data object which represents the brand new created server resource document or boolean false
   * @param {boolean} isJobDone boolean indicating if job is done
   * @param {string} error message
   */
  /* sendNotification(job, data, isJobDone, err) {
        data = data || false;
        err = err || false;
        let notification_job = new RabbitEnvelop({
            uuid: job.uuid,
            from: job.from,
            payload: job.payload,
            entity: job.entity,
            action: job.action,
            data: data,
            success: isJobDone,
            error: err,
            status: isJobDone ? "done" : "not done"
        })
        this.application.sender.send.notification(notification_job)
&nbsp;
    }
    // alias to sendNotification
    sendErrorNotification(job, errorMessage) {
        console.error(errorMessage)
        console.warn('tried job: ', job)
        this.sendNotification(job, false, false, {
            message: errorMessage
        })
    } */
  // send message to Mediator
  sendClientNotification (c) {
    const data = c.data || false
    try {
      const clientNotificationJob = new RabbitEnvelop({
        uuid: c.job.uuid,
        from: c.job.from,
        to: c.job.from,
        payload: c.job.payload,
        entity: c.job.entity,
        action: c.job.action,
        data: data,
        success: !!data,
        error: c.error || <span class="branch-1 cbranch-no" title="branch not covered" >false,</span>
        status: d</span>ata ? <span class="branch-0 cbranch-no" title="branch not covered" >'done' : 'not done'
      })
&nbsp;
      this.application.sender.send.notifyMediator(clientNotificationJob)
    } catch (e) {
<span class="cstat-no" title="statement not covered" >      this.application.console.warn(' sendClientNotification ERROR ')</span>
<span class="cstat-no" title="statement not covered" >      this.application.console.warn(e)</span>
    }
  }
&nbsp;
  // send job result to Log queue
  sendLog (c) {
    const data = c.data || false
    const self = this
&nbsp;
    // set on app.js
    <span class="missing-if-branch" title="if path not taken" >I</span>if (this.application.c.jobLogReader) {
<span class="cstat-no" title="statement not covered" >      return</span>
    }
&nbsp;
    // set on config
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!this.application.config.mq.isSendJobLog) {
<span class="cstat-no" title="statement not covered" >      return</span>
    }
&nbsp;
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!c.job.action) {
<span class="cstat-no" title="statement not covered" >      this.application.console.warn(' NO JOB to log ')</span>
<span class="cstat-no" title="statement not covered" >      return</span>
    }
&nbsp;
    try {
      const logJob = new RabbitEnvelop({
        uuid: c.job.uuid,
        from: c.job.from,
        to: c.job.from,
        payload: {
          uuid: c.job.uuid,
          from: c.job.from,
          payload: c.job.payload,
          entity: c.job.entity,
          action: c.job.action,
          data: data,
          success: c.success || false,
          error: c.error || <span class="branch-1 cbranch-no" title="branch not covered" >false,</span>
          status: d</span>ata ? <span class="branch-0 cbranch-no" title="branch not covered" >'done' : 'not done',
          companyId: self.application.config.app.companyCode
        },
        entity: c.job.entity,
        action: c.job.action,
        data: data,
        success: c.success || false,
        error: c.error || <span class="branch-1 cbranch-no" title="branch not covered" >false,</span>
        status: d</span>ata ? <span class="branch-0 cbranch-no" title="branch not covered" >'done' : 'not done'
      })
      // console.log('logJob', logJob)
      this.application.sender.send.log(logJob)
    } catch (e) {
<span class="cstat-no" title="statement not covered" >      this.application.console.warn(' sendLog ERROR ')</span>
<span class="cstat-no" title="statement not covered" >      this.application.console.warn(e)</span>
    }
  }
&nbsp;
  // check if task is valid. silently call jobNotDone() if not valid
  isValidJob (job, msg) {
    let ok = true
&nbsp;
    msg = msg || false
&nbsp;
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!validateJob(job)) {
<span class="cstat-no" title="statement not covered" >      ok = false</span>
<span class="cstat-no" title="statement not covered" >      this.jobNotDone(</span>
        job,
        msg,
        'Error when saving on table - job is not valid.'
      )
    }
    return ok
  }
&nbsp;
  // must be called when worker complete job execution with success
  jobDone (<span class="fstat-no" title="function not covered" >job, data, msg) {</span>
    // client acknowledgement is received
<span class="cstat-no" title="statement not covered" >    if (msg) {</span>
<span class="cstat-no" title="statement not covered" >      this.application.channel.ack(msg)</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    this.application.metrics.messages.executed.inc()</span>
&nbsp;
    //  this.application.redis.store.set('JobInProgress_' + this.application.config.mq.workerName, '{}')
&nbsp;
<span class="cstat-no" title="statement not covered" >    this.sendAllMessages(job, true, false, data, true)</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    this.application.console.info(' [x] Done ')</span>
  }
&nbsp;
  // must be called when worker complete job execution with no success
  jobNotDone (job, msg, errMessage) {
    <span class="missing-if-branch" title="if path not taken" >I</span>if (msg) {
<span class="cstat-no" title="statement not covered" >      this.application.channel.nack(msg, false, false)</span>
    }
&nbsp;
    this.application.metrics.messages.errored.inc()
&nbsp;
    // this.application.redis.store.set('JobInProgress_' + this.application.config.mq.workerName, JSON.stringify(job))
&nbsp;
    this.sendAllMessages(job, false, errMessage, false, false)
&nbsp;
    this.application.console.warn(' [x] Done with ERROR ')
  }
&nbsp;
  sendAllMessages (
    job,
    success = <span class="branch-1 cbranch-no" title="branch not covered" >false,</span>
    error = <span class="branch-1 cbranch-no" title="branch not covered" >false,</span>
    data = <span class="branch-1 cbranch-no" title="branch not covered" >false,</span>
    isJobDone = <span class="branch-1 cbranch-no" title="branch not covered" >false</span>
  ) {
    // console.log('job', job)
    /**
     *  send message about the JOB execution to jobLogQueue
     *  the jobLogQueue will be used for job recovery and job execution stats
     *  if this app is a jo log reader, then dont create a log
     * */
&nbsp;
    this.sendLog({
      job,
      data,
      success,
      error
    })
&nbsp;
    /**
     *  send message to the Mediator queue
     *  the Mediator queue will be used to send messages to connected JumentiX clients
     *  about the job execution
     * */
    <span class="missing-if-branch" title="else path not taken" >E</span>if (this.application.config.mq.isNotifyMediator) {
      this.sendClientNotification({
        job,
        data,
        error
      })
    }
&nbsp;
    // send messages to client via Gmail
    <span class="missing-if-branch" title="else path not taken" >E</span>if (this.application.config.mq.isSendClientMail) {
      <span class="missing-if-branch" title="else path not taken" >E</span>if (!this.application.c.jobLogReader) {
        this.application.sender.send.jobMailNotification({
          job,
          // msg: msg,
          data,
          error
        })
      }
    }
  }
}
&nbsp;
export default Job
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Nov 25 2020 16:19:18 GMT-0200 (Brasilia Summer Time)
</div>
</div>
<script src="../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../sorter.js"></script>
</body>
</html>
