<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/lib/auth/services/session.service.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../../prettify.css" />
    <link rel="stylesheet" href="../../../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../../../index.html">all files</a> / <a href="index.html">src/lib/auth/services/</a> session.service.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">77.46% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>55/71</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">58.82% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>20/34</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>4/4</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">91.18% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>31/34</span>
      </div>
      <div class='fl pad1y'>
        <span class="strong">1 branch</span>
        <span class="quiet">Ignored</span>  &nbsp;&nbsp;&nbsp;&nbsp;
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import { calc, time } from 'role-calc'
import { UserAccess } from '../../models/mongoose/UserAccess'
import { r } from '../../redis-jwt'
import config from '../../../config'
import { error, result, invalid, unauthorized } from '../../response'
// import { copy } from '../../util'
&nbsp;
const env = process.env.NODE_ENV || 'development'
const conf = config[env]
&nbsp;
// Initialize after login success
export <span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >async function initialize(err, user, res, req) {</span></span></span></span></span>
  // console.log('----&gt; session.service initialize', info)
  let ttl = null,
    nowInMs = 0,
    _expiresInMs = 0,
    expires = new Date(),
    info = {
      session_id: '0'
    },
    tokenKey = '',
    userObject = {}
&nbsp;
  <span class="missing-if-branch" title="if path not taken" >I</span>if (typeof req.body.info !== 'undefined') {
<span class="cstat-no" title="statement not covered" >    info = req.body.info</span>
  }
&nbsp;
  try {
    // Errors
    if (<span class="missing-if-branch" title="else path not taken" >E</span>err) {
<span class="cstat-no" title="statement not covered" >      console.error(' err err err err', err)</span>
      return invalid(res, {
        message: err.message || err,
        error: err.stack || err.message || err || {}
      })
    }
&nbsp;
    if (!<span class="missing-if-branch" title="else path not taken" >E</span>user) {
<span class="cstat-no" title="statement not covered" >      console.error(' NOT USER &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; ', user)</span>
      return unauthorized(res, {
        message: 'Something went wrong with "user", please try again.'
      })
    }
&nbsp;
    if (!<span class="missing-if-branch" title="else path not taken" >E</span>user.human) {
<span class="cstat-no" title="statement not covered" >      console.error(' NOT USER &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; ', user)</span>
      return unauthorized(res, {
        message: 'Something went wrong "user.human", please try again.'
      })
    }
&nbsp;
    nowInMs = new Date().getTime()
&nbsp;
    // Calculate ttl by user roles, by default takes the role with the longest 'max'
    ttl = calc(time(conf.roles, user.roles), 'max')
&nbsp;
    tokenKey = user._id.toString() + '_' + info.session_id
&nbsp;
    userObject = JSON.parse(JSON.stringify(user))
    userObject.name = user.human.first_name + ' ' + user.human.last_name
    userObject.role = userObject.roles[0]
    delete userObject.password
&nbsp;
    const token = await r.sign(tokenKey, {
      ttl,
      dataSession: {
        // save data in REDIS (Private)
        // ip : res.req.headers['x-forwarded-for'] || res.req.connection.remoteAddress,
        // agent : res.req.headers['user-agent']
      },
      dataToken: {
        // save data in Token (Public)
        // example : 'I travel with the token!'
        user: userObject
      }
    })
&nbsp;
    <span class="missing-if-branch" title="else path not taken" >E</span>if (typeof ttl === 'string') {
      _expiresInMs = parseInt(ttl.split(' ')[0]) * 60 * 1000
      expires = new Date(_expiresInMs + nowInMs)
    }
&nbsp;
    // Save token in cookies
    res.cookie('token', JSON.stringify(token), {
      maxAge: _expiresInMs + nowInMs,
      httpOnly: true
    })
&nbsp;
    // console.log(access)
    // userObject must have access
    userObject.access = await UserAccess.find({ user: user._id })
      .sort({ date: -1 })
      .limit(50)
&nbsp;
    // if local return token
    if (<span class="missing-if-branch" title="if path not taken" >I</span>user.provider === 'local') {
      return <span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >r</span></span>esult(res, {
        token,
        user: userObject,
        expires,
        api: 'http://' + conf.server.ip + ':' + conf.server.port + '/'
      })
    }
&nbsp;
    // if Social redirect to..
<span class="cstat-no" title="statement not covered" ><span class="branch-6 cbranch-no" title="branch not covered" >    res.redirect(`/?token=${token}`)</span></span>
  } catch (err) {
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="branch-7 cbranch-no" title="branch not covered" >    c</span></span></span>onsole.error('XX&gt;&gt;&gt;&gt;&gt;&gt; ', err)</span></span>
    return error(res, {
      message: err
    })
  }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Nov 25 2020 16:19:18 GMT-0200 (Brasilia Summer Time)
</div>
</div>
<script src="../../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../../sorter.js"></script>
</body>
</html>
